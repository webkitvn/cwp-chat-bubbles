{"id":"cwp-chat-bubbles-3c6","title":"Add PHPUnit test coverage for critical plugin functions","description":"**Issue**: No automated tests exist for this plugin. Critical areas that need testing:\n- validate_contact_value() in Items_Manager (security-critical)\n- should_load_on_current_page() in Data Service\n- sanitize_options() in Settings\n- AJAX handlers (save/delete/reorder items)\n- Frontend rendering logic\n\n**Recommended approach**:\n1. Add PHPUnit for PHP testing:\n   - Create tests/ directory structure\n   - Add phpunit.xml.dist\n   - Test Items_Manager CRUD operations\n   - Test Settings sanitization\n   - Test Frontend conditional loading\n\n2. Add Jest for JavaScript testing:\n   - Test form validation in admin.js\n   - Test platform URL generation\n   - Test modal handling\n\n**Files to create**:\n- tests/bootstrap.php\n- tests/phpunit.xml.dist\n- tests/test-items-manager.php\n- tests/test-settings.php\n- tests/js/admin.test.js\n\n**Estimated time**: 4-6 hours","acceptance_criteria":"- tests/ directory with PHPUnit setup\n- phpunit.xml.dist configured\n- Tests for validate_contact_value() with valid/invalid inputs\n- Tests for sanitize_item_data() \n- Tests for Settings sanitization\n- All tests pass: vendor/bin/phpunit","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-04T16:39:43.716284+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.417451+07:00"}
{"id":"cwp-chat-bubbles-4f3","title":"Remove legacy dead code from Frontend class","description":"**Issue**: After the Data Service refactor, several methods in class-frontend.php are now legacy/dead code:\n- render_template() (lines 185-223) - replaced by render_template_optimized()\n- render_fallback_template() (lines 259-317) - still used but duplicates logic from Data Service\n- is_current_page_excluded() (lines 325-338) - logic moved to Data Service\n- generate_platform_url() (lines 348-384) - duplicated, see separate issue\n- get_platform_icon_url() (lines 393-395) - simple wrapper, keep or inline\n- get_main_icon_url() (lines 403-416) - duplicated in Data Service\n\n**Fix**:\n1. Remove unused render_template() method\n2. Update render_fallback_template() to use Data Service processed data\n3. Remove is_current_page_excluded() as it's handled by Data Service\n4. Consolidate URL/icon methods per duplication issue\n\n**Files**: includes/class-frontend.php\n\n**Estimated time**: 30 minutes","acceptance_criteria":"- render_template() method removed\n- is_current_page_excluded() method removed\n- generate_platform_url() removed (uses Items_Manager)\n- get_main_icon_url() removed (uses Settings)\n- Frontend still renders correctly via shortcode and auto-inject","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T16:39:43.550835+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.287594+07:00","dependencies":[{"issue_id":"cwp-chat-bubbles-4f3","depends_on_id":"cwp-chat-bubbles-li7","type":"blocks","created_at":"2026-01-04T16:40:41.749445+07:00","created_by":"cuongpham"}]}
{"id":"cwp-chat-bubbles-5pl","title":"Remove redundant basename check in uninstall.php","description":"**Issue**: The plugin basename verification in uninstall.php is hardcoded and fragile:\n\n\\`\\`\\`php\n// Verify this is our plugin being uninstalled\nif (plugin_basename(__FILE__) !== 'cwp-chat-bubbles/uninstall.php') {\n    exit;\n}\n\\`\\`\\`\n\n**Problem**: If the plugin folder is renamed (e.g., to 'cwp-chat-bubbles-v2'), uninstall will silently fail.\n\n**Fix**: This check is actually redundant since WordPress only calls uninstall.php for the correct plugin. The WP_UNINSTALL_PLUGIN constant check is sufficient:\n\\`\\`\\`php\n// This is sufficient - remove the basename check\nif (!defined('WP_UNINSTALL_PLUGIN')) {\n    exit;\n}\n\\`\\`\\`\n\n**Files**: uninstall.php (lines 22-24)\n\n**Estimated time**: 5 minutes","acceptance_criteria":"- plugin_basename check removed (lines 22-24)\n- WP_UNINSTALL_PLUGIN check remains as sole guard\n- Uninstall works regardless of plugin folder name","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-04T16:40:32.827564+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:53.243077+07:00"}
{"id":"cwp-chat-bubbles-6z2","title":"Fix audit log: disable autoload and add 30-day rotation","description":"**Issue**: The security audit log stored in wp_options keeps 100 entries but:\n1. Uses default autoload='yes', loading on every page\n2. No time-based rotation (old entries persist indefinitely)\n\n**Current code** (class-options-page.php):\n\\`\\`\\`php\n// Always auto-loaded even when not needed\nupdate_option('cwp_chat_bubbles_audit_log', \\$log);\n\\`\\`\\`\n\n**Fix**:\n1. Use autoload=false when updating:\n   \\`update_option('cwp_chat_bubbles_audit_log', \\$log, false);\\`\n\n2. Add time-based rotation (e.g., delete entries older than 30 days):\n\\`\\`\\`php\n\\$log = array_filter(\\$log, function(\\$entry) {\n    return strtotime(\\$entry['time']) \u003e strtotime('-30 days');\n});\n\\`\\`\\`\n\n**Files**: includes/class-options-page.php (log_admin_action method)\n\n**Estimated time**: 15 minutes","acceptance_criteria":"- update_option() uses autoload=false for audit log\n- Entries older than 30 days are filtered out before save\n- Log still records new entries correctly\n- Option not loaded on every page load (verify with Query Monitor)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T16:39:43.881239+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:52.982665+07:00"}
{"id":"cwp-chat-bubbles-dhm","title":"Remove debug console.log from production admin.js","description":"**Issue**: Debug console.log statement left in production code:\n\nadmin/js/admin.js around line 590:\n\\`\\`\\`javascript\nconsole.log('QR code preview error:', error);\n\\`\\`\\`\n\n**Impact**: Pollutes browser console in production, unprofessional.\n\n**Fix**: Remove the console.log or wrap in development check:\n\\`\\`\\`javascript\n// Option 1: Remove entirely\n// Option 2: Keep for debugging but check environment\nif (typeof wpAjax.debug !== 'undefined' \u0026\u0026 wpAjax.debug) {\n    console.log('QR code preview error:', error);\n}\n\\`\\`\\`\n\n**Files**: admin/js/admin.js\n\n**Estimated time**: 5 minutes","acceptance_criteria":"- console.log('QR code preview error:') removed\n- No console.log statements in production code\n- QR code error handling still works (silent fail or user notification)","status":"open","priority":3,"issue_type":"bug","created_at":"2026-01-04T16:40:32.666767+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:53.177025+07:00"}
{"id":"cwp-chat-bubbles-frm","title":"Upgrade deprecated npm dependencies (ESLint 9, remove rimraf)","description":"**Issue**: Several npm dependencies are deprecated or outdated:\n- ESLint 8.57.0 - v8.x is deprecated, upgrade to v9.x\n- glob (transitive) - deprecated, use native fs.glob or fast-glob\n- rimraf 5.x - deprecated, use native fs.rm\n\n**Current versions in package.json**:\n\\`\\`\\`json\n\"eslint\": \"^8.57.0\"\n\"rimraf\": \"^5.0.7\"\n\\`\\`\\`\n\n**Fix**:\n1. Upgrade ESLint to v9.x (requires config migration to flat config)\n2. Replace rimraf with native Node.js fs.rm in package.json scripts:\n   \\`\"clean\": \"node -e \\\"require('fs').rmSync('assets/css', {recursive:true, force:true}); require('fs').rmSync('assets/js', {recursive:true, force:true})\\\"\"\\`\n3. Run \\`pnpm update\\` to get latest compatible versions\n\n**Files**: package.json, pnpm-lock.yaml\n\n**Estimated time**: 1 hour (ESLint config migration takes time)","acceptance_criteria":"- ESLint upgraded to v9.x with flat config (eslint.config.js)\n- rimraf removed, clean script uses native fs.rm\n- pnpm build runs without errors\n- pnpm lint runs without errors","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T16:39:43.635059+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.352738+07:00"}
{"id":"cwp-chat-bubbles-ifp","title":"Fix XSS vulnerability in admin.js jQuery .html() calls","description":"**Security Issue**: admin.js uses jQuery .html() with template literals without proper escaping at multiple locations:\n- Line 309: \\`\\$('#cwp-items-container').html(response.data.items_html)\\`\n- Line 480: \\`showNotice()\\` function creates HTML from message parameter\n- Line 626: Template literal injection in modal form\n- Line 657: Similar pattern\n\n**Risk**: Potential XSS if server response is compromised or admin input not properly sanitized.\n\n**Fix**: Replace .html() with DOM manipulation methods or use proper escaping. Example:\n\\`\\`\\`javascript\n// Instead of:\n\\$notice.html(message);\n\n// Use:\n\\$notice.text(message);\n// Or create elements properly:\nconst \\$p = \\$('\u003cp\u003e').text(message);\n\\$notice.empty().append(\\$p);\n\\`\\`\\`\n\n**Files**: admin/js/admin.js\n\n**Estimated time**: 30 minutes","acceptance_criteria":"- All jQuery .html() calls with dynamic content replaced with .text() or DOM methods\n- No template literals directly inserted into DOM without escaping\n- Tested: admin panel still functions correctly after changes\n- No console errors in browser DevTools","status":"open","priority":0,"issue_type":"bug","created_at":"2026-01-04T16:38:26.137946+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.086622+07:00"}
{"id":"cwp-chat-bubbles-li7","title":"Consolidate generate_platform_url() into Items_Manager","description":"**Issue**: generate_platform_url() is duplicated in 3 files with slight inconsistencies:\n- includes/class-data-service.php (lines 247-282)\n- includes/class-frontend.php (lines 348-384)\n- includes/class-assets.php (lines 303-339)\n\n**Inconsistency**: Zalo URL differs:\n- Data Service: 'https://zalo.me/' . \\$contact_value . '?openChat=true'\n- Frontend/Assets: 'https://zalo.me/' . \\$contact_value (missing ?openChat=true)\n\nAlso duplicated: get_main_icon_url() in Data Service and Frontend.\n\n**Fix**: \n1. Move generate_platform_url() to Items_Manager as the single source of truth\n2. Move get_main_icon_url() to Settings class\n3. Update all callers to use centralized methods\n\n**Files**:\n- includes/class-items-manager.php (add methods here)\n- includes/class-data-service.php\n- includes/class-frontend.php\n- includes/class-assets.php\n\n**Estimated time**: 45 minutes","acceptance_criteria":"- Single generate_platform_url() method in Items_Manager class\n- Single get_main_icon_url() method in Settings class  \n- All callers (Data Service, Frontend, Assets) use centralized methods\n- Zalo URL includes ?openChat=true consistently\n- All frontend links work correctly (test each platform)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T16:39:43.463785+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.221539+07:00"}
{"id":"cwp-chat-bubbles-qqz","title":"Implement QR code migration from old options format","description":"**Issue**: The migrate_qr_code() method in Items_Manager is a placeholder that always returns 0:\n\n\\`\\`\\`php\nprivate function migrate_qr_code(\\$qr_code_path) {\n    // This is a placeholder for QR code migration\n    // In a real scenario, you'd handle file uploads to media library\n    return 0;\n}\n\\`\\`\\`\n\n**Impact**: QR codes from old options format are not migrated to the new table structure. Users upgrading from older versions lose their QR code associations.\n\n**Fix**: Implement proper migration:\n1. Check if \\$qr_code_path is already an attachment ID\n2. If it's a URL, try to find matching attachment by URL\n3. If it's a file path, sideload to media library\n4. Return the attachment ID\n\n**Files**: includes/class-items-manager.php (lines 474-478)\n\n**Estimated time**: 45 minutes","acceptance_criteria":"- migrate_qr_code() handles attachment IDs (returns as-is)\n- Handles URLs by finding matching attachment in media library\n- Falls back to 0 if no match found (graceful degradation)\n- Migration test: old format data correctly migrates QR associations","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T16:40:32.498159+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:53.047223+07:00"}
{"id":"cwp-chat-bubbles-tbw","title":"Sync plugin version to 1.0.2 across all files","description":"**Issue**: Plugin version is inconsistent across files:\n- cwp-chat-bubbles.php header: Version: 1.0.2\n- CWP_CHAT_BUBBLES_VERSION constant (line 27): '1.0.0'\n- package.json: '1.0.0'\n\n**Impact**: \n- Cache busting relies on CWP_CHAT_BUBBLES_VERSION for asset versioning\n- Users may see stale CSS/JS files after updates\n- WordPress update checks use header version\n\n**Fix**: Sync all versions to 1.0.2 (or appropriate version):\n1. Update CWP_CHAT_BUBBLES_VERSION constant to '1.0.2'\n2. Update package.json version to '1.0.2'\n\n**Files**: \n- cwp-chat-bubbles.php (line 27)\n- package.json (line 2)\n\n**Estimated time**: 5 minutes","acceptance_criteria":"- CWP_CHAT_BUBBLES_VERSION constant = '1.0.2'\n- package.json version = '1.0.2'\n- Plugin header Version = 1.0.2\n- Run pnpm build to verify no errors","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-04T16:38:36.457008+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:30.151771+07:00"}
{"id":"cwp-chat-bubbles-uv7","title":"Replace wp_cache_flush() with targeted cache deletes in uninstall","description":"**Issue**: uninstall.php calls wp_cache_flush() which clears the ENTIRE object cache, not just plugin data:\n\n\\`\\`\\`php\n// Clear any cached data\nwp_cache_delete('cwp_chat_bubbles_frontend_data', 'cwp_chat_bubbles');\nwp_cache_flush(); // This clears ALL cache!\n\\`\\`\\`\n\n**Impact**: On sites with persistent object caching (Redis, Memcached), this flushes all cached data for all plugins/themes, potentially causing performance issues.\n\n**Fix**: Delete only plugin-specific cache keys:\n\\`\\`\\`php\n// Delete specific cache keys instead of flushing all\nwp_cache_delete('cwp_chat_bubbles_frontend_data', 'cwp_chat_bubbles');\nwp_cache_delete('cwp_chat_bubbles_data_version', 'cwp_chat_bubbles');\nwp_cache_delete('cwp_items_all', 'cwp_chat_bubbles');\nwp_cache_delete('cwp_items_enabled', 'cwp_chat_bubbles');\n// Remove wp_cache_flush() call\n\\`\\`\\`\n\n**Files**: uninstall.php (line 58)\n\n**Estimated time**: 10 minutes","acceptance_criteria":"- wp_cache_flush() removed from uninstall.php\n- All plugin-specific cache keys deleted individually\n- Other plugins' cache unaffected during uninstall\n- Plugin uninstalls cleanly without errors","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T16:40:32.586322+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:53.111371+07:00"}
{"id":"cwp-chat-bubbles-xgu","title":"Move inline CSS from options page to SCSS build system","description":"**Issue**: class-options-page.php contains ~150 lines of inline CSS (lines 406-560) that should go through the SCSS build system instead.\n\n**Current state**: CSS is embedded in PHP using \\`\u003cstyle\u003e\\` tag inside render_options_page().\n\n**Benefits of moving to SCSS**:\n- Consistent styling with admin.scss\n- CSS minification in production\n- Better maintainability\n- Proper cache busting via versioned file\n\n**Fix**:\n1. Move inline styles to src/scss/admin.scss\n2. Remove inline \u003cstyle\u003e block from class-options-page.php\n3. Ensure admin.min.css is properly enqueued (already done in Assets class)\n\n**Files**:\n- includes/class-options-page.php (lines 406-560)\n- src/scss/admin.scss\n\n**Estimated time**: 30 minutes","acceptance_criteria":"- All inline \u003cstyle\u003e content from class-options-page.php moved to src/scss/admin.scss\n- No inline \u003cstyle\u003e tags remain in PHP file\n- pnpm build generates updated admin.min.css\n- Admin page styling unchanged visually","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T16:39:43.799676+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:45:52.916419+07:00"}
{"id":"cwp-chat-bubbles-y17","title":"Zalo URL inconsistent - missing ?openChat=true in some paths","description":"**Issue**: Zalo URL generation is inconsistent between code paths:\n\n**Data Service** (includes ?openChat=true):\n\\`\\`\\`php\ncase 'zalo':\n    return 'https://zalo.me/' . \\$contact_value . '?openChat=true';\n\\`\\`\\`\n\n**Frontend \u0026 Assets** (missing ?openChat=true):\n\\`\\`\\`php\ncase 'zalo':\n    return 'https://zalo.me/' . \\$contact_value;\n\\`\\`\\`\n\n**Impact**: Users may not get the optimal Zalo experience (direct chat open) depending on which code path is used.\n\n**Fix**: Add ?openChat=true to all Zalo URL generation, or consolidate to single method (see duplication issue).\n\n**Files**:\n- includes/class-frontend.php (line 359)\n- includes/class-assets.php (line 315)\n\n**Estimated time**: 5 minutes (or resolved by duplication fix)","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-04T16:40:32.747508+07:00","created_by":"cuongpham","updated_at":"2026-01-04T16:46:03.35325+07:00","closed_at":"2026-01-04T16:46:03.35325+07:00","close_reason":"Will be resolved by cwp-chat-bubbles-li7 (code consolidation ensures consistent Zalo URL)","dependencies":[{"issue_id":"cwp-chat-bubbles-y17","depends_on_id":"cwp-chat-bubbles-li7","type":"blocks","created_at":"2026-01-04T16:40:41.684055+07:00","created_by":"cuongpham"}]}
